{% extends "base.html"%}

{# Номер лаб раб: #}
{%block lab%}Лабораторная работа 6{%endblock%}

{% block script %}
<script>
    function getOfficeList() {
        const url = '/lab6/json-rpc-api/';
        const json = {
            "jsonrpc": '2.0',
            "method": 'info',
            'id': Math.round(Math.random() * 1000000)
        };

        fetch(url, {
            method: 'POST',
            headers: {
            'Content-Type': 'application/json'
            },
            body: JSON.stringify(json)
        }).then(function(response){
            return response.json()
        }).then(function(data){
            const officeList = data.result;

            const ul = document.getElementById('office-list');
            for(let office of officeList){
                const li = document.createElement('li');
                li.innerText = `${office.number}: ${office.tenant || 'свободен'}`

                const bookButton = document.createElement('button');
                bookButton.innerText = 'Зарезервировать';
                bookButton.onclick = function() {
                    book(office.number);
                }
                li.appendChild(bookButton)

                ul.appendChild(li);
            }

        })
    }

    function book(number){
        const url = '/lab6/json-rpc-api/';
        const json = {
            "jsonrpc": '2.0',
            "method": 'book',
            'params': number,
            'id': Math.round(Math.random() * 1000000)
        };

        fetch(url, {
            method: 'POST',
            headers: {
            'Content-Type': 'application/json'
            },
            body: JSON.stringify(json)
        }).then(function(response){
            return response.json()
        }).then(function(data){
            if(data.error){
                if(data.error.code == 1){
                    alert("Пожалуйста, авторизуйтесь")
                }
                if(data.error.code == 2){
                    alert("Офис уже занят")
                }
            }

            const ul = document.getElementById('office-list').innerHTML = '';
            getOfficeList();
        })
    }

    document.addEventListener('DOMContentLoaded', function(){
        getOfficeList();
    })
</script>
{% endblock %}

{# Контент: #}
{%block main%}
<div><a href="/">< К Списку работ</a></div>
<h1>Тема лабораторной - API JSON-RPC. Список сделанных страниц:</h1>
<div>
    <h2>Список кабинетов</h2>
    <ul id="office-list"></ul>
</div>


{%endblock%}